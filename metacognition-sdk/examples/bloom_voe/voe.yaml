metacognition:
  chains:
    voe:
      event: on_user_message
      output: void
      min_completed_turns: 1
      steps:
        user_prediction:
          type: inference
          prompt: >
            Generate a "thought" that makes a prediction about what the user will say based on the way the conversation has been going and also lists other pieces of data that would help improve your prediction.

            History: ```

            {prev_conversation_history}

            ```

            thought:
        user_model_query:
          type: user_model_query
          query: >
            You're trying to find personal information that could improve a prediction about what the user is going to say.

            History: """
            {prev_conversation_history}
            """

            Current prediction: """
            {user_prediction}
            """

            Now write a query to a model of the user that would yield relevant personal information for improving the prediction.
        user_prediction_revision:
          type: inference
          prompt: >
            You are tasked with revising theory of mind "thoughts" about what the user is going to say. Here is the thought generated previously:

            Thought: """
            {user_prediction}
            """

            Based on this thought, the following personal data has been retrieved:

            Personal Data: """
            {user_model_query}
            """

            And here's the conversation history that was used to generate the original thought:

            History: """
            {prev_conversation_history}
            """

            Given the thought, conversation history, and personal data, revise the thought if you believe there are changes to be made.

            thought revision:
        voe_thought:
          type: inference
          prompt: >
            Below is a "thought" about what the user was going to say, and then what the user actually said. Generate a theory of mind prediction about the user based on the difference between the "thought" and actual response.

            Thought: """
            {user_prediction_revision}
            """

            Actual: """
            {user_message}
            """

            Provide the theory of mind prediction solely in reference to the Actual statement, i.e. do not generate something that negates the thought. Do not speculate anything about the user.
        user_model_revision:
          type: user_model_revision
          insight: >
            {voe_thought}

    get_context:
      event: on_user_message
      output: agent_context
      steps:
        thought:
          type: inference
          prompt: >
            You are Bloom, a subversive-minded learning companion. Your job is to employ your theory of mind skills to predict the user's mental state.

            Current dialogue:
            {conversation_history}

            Generate a "thought" that makes a prediction about the user's needs given current dialogue and also lists other pieces of data that would help improve your prediction.
        user_model_query:
          type: user_model_query
          query: >
            You're trying to find personal information that could improve this thought about the user's needs: """
            {thought}
            """

            Current dialogue: """
            {conversation_history}
            """
        thought_revision:
          type: inference
          prompt: >
            You are tasked with revising theory of mind assessments about your user. Here is a thought generated by Bloom, the subversive learning companion:

            Thought: """
            {thought}
            """

            Based on this thought, the following personal data has been retrieved:

            Personal Data: """
            {user_model_query}
            """

            Given the thought and personal data, revise the thought.

            thought revision:
